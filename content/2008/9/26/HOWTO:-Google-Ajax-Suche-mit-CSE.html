+++
title = "HOWTO: Google-Ajax-Suche mit CSE"
date = "2008-09-26T10:09:00"
author = "Dr. Azrael Tod"
tags = ["Softwareschrott", "Technik"]
issoid = "blog/801"
aliases = "blog/801"
+++

<p><a href="/2008/09/18/google-is-evil/">Neulich erst habe ich mich aufgeregt</a> dass man das Google-Iframe f&uuml;r die <a href="http://www.google.com/uds/samples/cse/index.html" target="_blank">CSE-Suche</a> so mies anpassen kann. Der Grund daf&uuml;r ist nat&uuml;rlich dass Google nie vor hatte dies zu erm&ouml;glichen. F&uuml;r derartige Anspr&uuml;che gibt es die sehr praktische <a href="http://code.google.com/apis/ajaxsearch/documentation/reference.html" target="_blank">AJAX-API</a> oder alternativ das <a href="http://code.google.com/apis/ajaxsearch/documentation/reference.html#_intro_fonje" target="_blank">REST-Interface zu dieser API</a>. Ich habe mich also mal wieder v&ouml;llig unsinnig hingesetzt, <a href="http://www.google.com/afsonline/show_afs_search.js" target="_blank">mehrere Seiten Obfuscated-Code</a> formatiert und gelesen, nur um 1-2 Details wie die Breite des Frames doch noch anzupassen.</p>
<p>Doch wie nutzt man diese API wirklich effektiv? Die <a href="http://code.google.com/apis/ajaxsearch/samples.html" target="_blank">ersten paar Beispiele</a> erzeugen zwar eine nette AJAX-Suchfunktion, aber wirklich an die eigenen Bed&uuml;rfnisse ist sie ja nicht angepasst. Besser ist da schon das <a href="http://www.google.com/uds/samples/apidocs/raw-searchers.html" target="_blank">RawSearchControl-Beispiel</a>, an dem ich mich orientiert habe.<br/>Es versucht viel eher die Daten selbst zu beschaffen um dann die Elemente per Hand zu zeichnen.<!--more--></p>
<p>Meine Realisation sieht dann so aus:</p>
<p>Als erstes basteln wir uns eine HTML-Seite die folgende Tags enth&auml;llt:<br/><code> </code><br/></p><pre>    &lt;script type="text/javascript" src="gajax.js" /&gt;<br/>    &lt;div id="searchform"&gt;Bitte kurz warten!&lt;/div&gt;<br/>    &lt;div id="results"&gt;&lt;/div&gt;<br/>    &lt;div id="cursor"&gt;&lt;/div&gt;</pre><br/>Wo die Tags stehen und wie sie genau bezeichnet sind ist nat&uuml;rlich egal, man sollte nur daran denken diese dann auch in gajax.js einzutragen

<p>Wenn wir das haben, brauchen wir nat&uuml;rlich noch die Datei mit dem Javascript-Quellcode. Diese nennen wir mal gajax.js (ist ja auch schon oben referenziert) und werfen sie ins selbe Verzeichnis.<br/>Inhalt sieht dann etwa so aus:<br/><code> </code><br/></p><pre>    /*Wir h&auml;tten gerne eine Suche<br/>    ohne bereits eingebundenes Google-CSS<br/>    die Sprache von Textschnipseln sollte Deutsch sein*/<br/>    google.load("search", "1", {"nocss" : true, "language" : "de_DE"});

<p>    // Diese Funktion wird gerufen wenn die Google-Scripte fertig geladen sind<br/>    function initialize() {<br/>        new RawSearchControl();<br/>    }</p>

<p>    //Hier arrangieren wir das automatische laden von initialize()<br/>    google.setOnLoadCallback(initialize);</p>

<p>    //hier erledigen wir die grunds&auml;tzlichen Einstellungen, z.B. wo soll was angezeigt werden<br/>    function RawSearchControl()<br/>    {<br/>        //hier werden die Ergebnisse eingeblendet<br/>        this.results = document.getElementById("results");<br/>        //Hier wird die Steuerfunktion zum Bl&auml;ttern eingeblendet<br/>        this.cursorElement = document.getElementById("cursor");<br/>        //Position f&uuml;r das Suchformlar<br/>        this.searchform = document.getElementById("searchform");<br/>        //wir wollen eine Websuche, keine Videosuche oder gar Geo-Suche<br/>        this.searcher = siteSearch = new google.search.WebSearch();<br/>        //wir beschr&auml;nken die Suche auf unsere CSE<br/>        this.searcher.setSiteRestriction("CSESchl&uuml;sselIDhier:Eingeben");<br/>        //HTML f&uuml;r die Ergebnisse basteln wir selbst<br/>        this.searcher.setNoHtmlGeneration();<br/>        //diese Funktion wird ausgef&uuml;hrt wenn die Suche beendet ist<br/>        this.searcher.setSearchCompleteCallback(this,RawSearchControl.prototype.searchComplete);<br/>        //wir haben platz f&uuml;r mehrere Ergebnisse gleichzeitig<br/>        this.searcher.setResultSetSize(google.search.Search.LARGE_RESULTSET);<br/>        //wir erzeugen die Eingabe und Absendeelemente<br/>        this.searchForm = new google.search.SearchForm(true, this.searchform);<br/>        //beim Abschicken soll ohne reload onSubmit ausgef&uuml;hrt werden<br/>        this.searchForm.setOnSubmitCallback(this, RawSearchControl.prototype.onSubmit);<br/>    }</p>

<p>    RawSearchControl.prototype.onSubmit = function(form) {<br/>        if (form.input.value)<br/>        {<br/>            //Es wurde Submit ausgef&uuml;hrt, zeit den searcher mit den Daten zu f&uuml;ttern<br/>            this.searcher.execute(form.input.value);<br/>        }<br/>        //Wir wollen doch die Daten nicht noch zus&auml;tzlich abschicken oder?<br/>        return false;<br/>    }</p>

<p>    RawSearchControl.prototype.searchComplete = function()<br/>    {<br/>        //alte Ergebnisse werden erstmal gel&ouml;scht<br/>        this.clearResults();</p>

<p>        //Mal sehen was wir an neuen Ergebnissen haben...<br/>       if (this.searcher.results &amp;&amp; this.searcher.results.length &gt; 0)<br/>        {<br/>            for (var i=0; i&lt;this.searcher.results.length; i++)<br/>            {<br/>                var result = this.searcher.results[i];<br/>                var html = generateSingleResultHTML(result);<br/>                this.results.appendChild(html);<br/>            }<br/>            //nun noch schnell die Bl&auml;tter-Funktion zeichnen...<br/>            RawSearchControl.prototype.drawCursorControl(this.searcher);<br/>        }<br/>        else<br/>        {   //Nichts gefunden<br/>            var div = createDiv("Leider wurde nichts entsprechendes gefunden",'error');<br/>            this.results.appendChild(div);<br/>        }<br/>    }</p>

<p>    function generateSingleResultHTML(result)<br/>    {<br/>        /*<br/>        wir haben folgende Attribute von result zur Verf&uuml;gung und sollen daraus eine HTML-Struktur bauen:<br/>        .unescapedUrl       - die reine, blanke URL... ideal f&uuml;r einen Link<br/>        .titleNoFormatting  - Die &Uuml;berschrifft ohne &lt;b&gt;s, &lt;i&gt;s und &auml;hnliche Formatierung<br/>        .content            - Ein kurzes Textschnipsel aus dem Seiteninhalt<br/>        .visibleUrl         - die Adresse ohne http:// oder genauem Pfad<br/>        .title              - Der Titel 1:1 &uuml;bernommen<br/>        .URL                - die URL, mit http:// aber ohne Argumente, kann man auch anzeigen wenn man will<br/>        */<br/>    }</p>

<p>    //<br/>    RawSearchControl.prototype.drawCursorControl = function(searcher)<br/>    {<br/>        /*wir wollen das Steuerfeld zur Seitenauswahl ebenfalls selbst basteln<br/>        Sinnvolle Variablen zur Verwendung sind hier:<br/>        searcher.cursor.currentPageIndex    - aktuelle SeitenID<br/>        searcher.cursor.pages               - Array mit Seiten</p>

<p>        jedem Element sollte via methodClosure ein Verweis auf searcher.gotoPage mit<br/>        der angesprungenen Seitennummer als Argument angeh&auml;ngt werden*/<br/>        }<br/>    }</p>

<p>    //Aufr&auml;umarbeiten<br/>    RawSearchControl.prototype.clearResults = function()<br/>    {<br/>        removeChildren(this.results);<br/>        removeChildren(this.cursorElement);<br/>        removeChildren(this.pageinfo);<br/>    }</p>

<p>    /**<br/>    * Hier kommen noch einige allgemeine Funktionen um die DOM-Struktur umzubauen<br/>    */<br/>    function removeChildren(parent)<br/>    {<br/>        while (parent.firstChild)<br/>        {<br/>            parent.removeChild(parent.firstChild);<br/>        }<br/>    }</p>

<p>    function methodClosure(object, method, opt_argArray)<br/>    {<br/>        return function()<br/>        {<br/>            return method.apply(object, opt_argArray);<br/>        }<br/>    }<br/>    function createDiv(opt_text, opt_className)<br/>    {<br/>        var el = document.createElement("div");<br/>        if (opt_text)<br/>        {<br/>            el.innerHTML = opt_text;<br/>        }<br/>        if (opt_className)<br/>        {<br/>            el.className = opt_className;<br/>        }<br/>        return el;<br/>    }<br/>    function createP(opt_className, opt_text)<br/>    {/*...Inhalt wie createDiv...*/}<br/>    function createLink(href, opt_text, opt_target, opt_className, opt_divwrap)<br/>    {/*...Inhalt wie createDiv...*/}<br/>    function createSpan(opt_text, opt_className)<br/>    {/*...Inhalt wie createDiv...*/}<br/>    //viele Weitere Elemente folgen...</p></pre><br/>Das war zwar jetzt etwas l&auml;nger aber eigentlich &uuml;berhaupt nicht schwierig oder? Als Ergebnis erh&auml;llt man eine nette kleine Suchfunktion bei der man zwar viel von Hand bastelt, daf&uuml;r aber auch bei so ziemlich allem bestimmen kann wie es aussehen soll.<br/>Die <a href="http://code.google.com/apis/ajaxsearch/documentation/reference.html#_class_GwebResultCss" target="_blank">CSS-Anpassungen</a> (wir haben Google ja gesagt es soll sein eigenes CSS nicht mitliefern) &uuml;berlass ich dann mal euerer Fantasie.

<p>Beim n&auml;chsten Mal gibts dann vlt. eine Realisierung direkt in PHP, das scheint mir <a href="http://code.google.com/apis/ajaxsearch/documentation/reference.html#_intro_fonje" target="_blank">mindestens genauso einfach</a> zu sein, ben&ouml;tigt nat&uuml;rlich kein Java unso aber habe ich aber mal wieder erst entdeckt als die H&auml;lfte des Codes schon fertig war. Wenn ich am WE mal wieder zu viel Freizeit habe, k&ouml;nnte es sogar sein dass ich doch mal wieder an meinem eigentlich schon verworfenen Sacred-Chao(IRCBot)-Qu&auml;hlcode rumschraube und dem Ding nach all den Jahren doch noch eine funktionierende !google-Funktion einbau.</p>
